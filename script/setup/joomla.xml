<?xml version="1.0" ?>
<!-- $Id: build.xml shyam $ -->
<project name="Joomla Installation" basedir="." default="setup" description="Installing Joomla.">

	<target name="setup" depends="install_joomla, create_database">
	    <echo msg="Build done." />
	</target>	

	<target name="jconfig" description="Load configuration file">
		<!-- check for config, if not loaded, then please ask to user -->
	</target>


	<target name="install_joomla" depends="jconfig">
		<echo msg="Installing Joomla Files..." />

		<!-- decide folder name : custom  + user_name + cur_date + svn_ver-->
		<echo msg="Folder name generated as  : ${joomla.folder}" />

		<!-- Copy Joomla Folder to ROOT // FOLDERNAME  -->
		<echo msg="Copying folder TO: ${joomla.rootpath}/${joomla.folder}" />

		<mkdir dir="${joomla.rootpath}/${joomla.folder}" />

		<mkdir dir="${joomla.rootpath}/${joomla.folder}" />
		<untar file="./data/${pkg.version}.tar.gz" todir="${joomla.rootpath}/${joomla.folder}" />
		<exec command="mv -f ${joomla.rootpath}/${joomla.folder}/${pkg.version}/* ${joomla.rootpath}/${joomla.folder}" passthru="true" />
		<!--		
		<copy toDir="${joomla.rootpath}/${joomla.folder}" overwrite="true">
			<fileset dir="${joomla.rootpath}/${joomla.folder}/${pkg.version}">
			    <include name="*" />
			</fileset>
		</copy>
		-->

		<copy file="./data/database_${pkg.version}.sql" tofile="${joomla.rootpath}/${joomla.folder}/database.sql" overwrite="true"/>
		<copy file="./data/configuration.php" tofile="${joomla.rootpath}/${joomla.folder}/configuration.php" overwrite="true"/>

		<!-- replace configuration-->
		<reflexive>
			<fileset dir="${joomla.rootpath}/${joomla.folder}">
			    <include name="configuration.php" />
			    <include name="database.sql" />
			</fileset>
			 <filterchain>
				<replacetokens>
				    <token key="joomla.sitename" 		value="${joomla.sitename}/"/>
				    <token key="joomla.dbuser"   		value="${joomla.dbuser}"/>
				    <token key="joomla.dbpassword"   	value="${joomla.dbpassword}"/>
				    <token key="joomla.dbname"   		value="${joomla.dbname}"/>
				    <token key="joomla.dbprefix"   		value="${joomla.dbprefix}"/>
				    <token key="joomla.rootpath"   		value="${joomla.rootpath}"/>
				    <token key="joomla.folder"   		value="${joomla.folder}"/>
				</replacetokens>
			</filterchain>
		</reflexive>
		<echo msg="Joomla files copied .." />
		
		<!--  change owner of files to www-data -->
		<exec command="sudo chown -R www-data ./*" dir="${joomla.rootpath}/${joomla.folder}" />

	</target>


	<target name="create_database" depends="jconfig">
		<echo msg="Creating database and dumping sql into it." />
		<!-- fill data base -->
		<exec command="sudo mysql -uroot -ppassword --execute='CREATE DATABASE ${joomla.dbname};'" passthru="true" />
		<exec command="sudo mysql -uroot -ppassword --execute=${joomla.createUserQuery}" passthru="true" />
		<exec command="sudo mysql -uroot -ppassword --execute='GRANT ALL PRIVILEGES ON ${joomla.dbname}.* TO ${joomla.dbuser};'"  passthru="true" />
		<!-- <exec command="sudo mysql -uroot -ppassword - -execute='FLUSH PRIVILEGES';"  passthru="true" /> -->
		<exec command="sudo mysql -uroot -ppassword --database=${joomla.dbname} --execute='source ${joomla.dbdump}' "  passthru="true" />
		<echo msg="Database work done." />
	</target>

</project>
