<?xml version="1.0" ?>
<!-- $Id: build.xml shyam $ -->
<project name="JSPT Component" basedir="." default="build" description="Phing build script for JSPT package.">

	<target name="config" description="Load configuration file">
		<property file="build.properties"  override="false" />
	</target>

	
	<target name="build" description="build installable package only" depends="config,svn_lastrevision">

		<!-- delete packages -->
        <delete dir="${global.dir.packages}" includeemptydirs="true" />

		<mkdir dir="${global.dir.packages}" />
		<mkdir dir="${global.dir.tmp}" />

		<phingcall target="export_from_wc" />
		<!-- Process all build process here -->
		<phing phingfile="com_xipt.xml" inheritAll="true" target="build" />
		<phing phingfile="plg_xipt_system.xml" inheritAll="true" target="build" />
		<phing phingfile="plg_xipt_community.xml" inheritAll="true" target="build" />
		<phing phingfile="mod_xiptmembers.xml" inheritAll="true" target="build" />

		
		<delete file="${global.dir.packages}/JSPT-${global.version}.${svn.lastrevision}-Unzip-First.zip" />

		<mkdir dir="JSPT-${global.version}.${svn.lastrevision}-Unzip-First" />		
		<copy todir="JSPT-${global.version}.${svn.lastrevision}-Unzip-First">
			<fileset dir="${global.dir.packages}">
				<include name="com*${global.version}.${svn.lastrevision}.zip" />
				<include name="plg*${global.version}.${svn.lastrevision}.zip" />
				<include name="mod*${global.version}.${svn.lastrevision}.zip" />
			</fileset>

			<fileset dir="${global.dir.root}/data">
				<include name="JSPT_${global.version}_Documentation.pdf" />
			</fileset>
		</copy>

			<zip destfile="${global.dir.packages}/JSPT-${global.version}.${svn.lastrevision}-Unzip-First.zip" 
			basedir="JSPT-${global.version}.${svn.lastrevision}-Unzip-First" />

		<delete dir="JSPT-${global.version}.${svn.lastrevision}-Unzip-First" includeemptydirs="true"/>
		<delete dir="${global.dir.tmp}" includeemptydirs="true" />
	</target>


	<!-- Global Target -->
	<target name="export_from_wc" description="Export files from a local working copy" depends="config">
		<copy todir="${global.dir.tmp}">
			<fileset dir="${global.dir.local}">
				<include name="**" />
			</fileset>
		</copy>
		
		<!-- apply lint -->
			<analyze analyzerPath="/usr/local/bin/zca" disable="var-ref-notmodified,if-if-else,expr-unused,include-var" >
				<fileset dir="${global.dir.tmp}">
				    <include name="**/*.php"/>
				</fileset>
			</analyze>


			<exec command="phploc  ${global.dir.tmp} > loc.source.txt " escape="false" />
	        <exec command="phploc  --count-tests ${global.dir.root}/test > loc.test.txt " escape="false" />
<!--	        <exec command="pdepend  - -summary-xml=${global.dir.root}/data/pdepend.summary.xml - -jdepend-chart=${global.dir.root}/data/pdepend1.svg  - -overview-pyramid=${global.dir.root}/data/pdepend2.svg  ${global.dir.root}/source" escape="false" / > -->
	
	        <exec command="find  ${global.dir.tmp} | xargs -l1 grep -Hni xitodo  > ${global.dir.root}/data/xitodo.txt " escape="false" />
	        <exec command="find  ${global.dir.tmp} | xargs -l1 grep -Hn JSITE_PATH  > ${global.dir.root}/data/jsite-path.txt " escape="false" />
	        <exec command="find  ${global.dir.tmp} | xargs -l1 grep -Hn _REQUEST   > ${global.dir.root}/data/post-get-request.txt " escape="false" />
	        <exec command="find  ${global.dir.tmp} | xargs -l1 grep -Hn _POST     >> ${global.dir.root}/data/post-get-request.txt " escape="false" />
	        <exec command="find  ${global.dir.tmp} | xargs -l1 grep -Hn _GET      >> ${global.dir.root}/data/post-get-request.txt " escape="false" />
	        <exec command="find  ${global.dir.tmp} | xargs -l1 grep -Hn _SESSION  >> ${global.dir.root}/data/post-get-request.txt " escape="false" />
	        <exec command="find  ${global.dir.tmp} | xargs -l1 grep -Hn _GLOBALS  >> ${global.dir.root}/data/post-get-request.txt " escape="false" />
		<exec command="find  ${global.dir.tmp} -name '*.php' | xargs -l1 grep -Hn 'index.php' | grep -v 'JRoute'  > ${global.dir.root}/data/usejroute.txt " escape="false" />


		<!-- gather stats phpcpd / phploc / test-count,assert-count, xitodo/codrev numbers / coverage numbers  -->
	</target>

	<target name="svn_lastrevision" depends="config">
		<svnlastrevision workingcopy="${global.dir.root}" propertyname="svn.lastrevision" />
	</target>
	
</project>
